package com.lasthopesoftware.bluewater.client.access.subsonic.GivenASubsonicConnection.AndASearchQuery

import com.lasthopesoftware.TestUrl
import com.lasthopesoftware.bluewater.client.browsing.files.ServiceFile
import com.lasthopesoftware.bluewater.client.connection.SubsonicConnectionDetails
import com.lasthopesoftware.bluewater.client.connection.live.LiveSubsonicConnection
import com.lasthopesoftware.bluewater.client.connection.requests.FakeHttpConnection
import com.lasthopesoftware.bluewater.client.connection.requests.FakeHttpConnectionProvider
import com.lasthopesoftware.bluewater.client.connection.url.UrlBuilder.addParams
import com.lasthopesoftware.bluewater.client.connection.url.UrlBuilder.addPath
import com.lasthopesoftware.bluewater.client.connection.url.UrlBuilder.withSubsonicApi
import com.lasthopesoftware.bluewater.shared.promises.extensions.toExpiringFuture
import com.lasthopesoftware.resources.PassThroughHttpResponse
import com.lasthopesoftware.resources.strings.JsonEncoderDecoder
import io.mockk.mockk
import org.assertj.core.api.Assertions.assertThat
import org.junit.jupiter.api.BeforeAll
import org.junit.jupiter.api.Test

class `When searching for files` {
	companion object {
		private const val query = "21 Grams"
	}

	private val mut by lazy {
		val httpConnection = FakeHttpConnection().apply {
			mapResponse(TestUrl.withSubsonicApi().addPath("search2.view").addParams("f=json").addParams("query=$query", "albumCount=0", "songCount=1000")) {
				PassThroughHttpResponse(
					200,
					"OK",
					"""
{
  "subsonic-response": {
    "status": "ok",
    "version": "1.16.1",
    "type": "navidrome",
    "serverVersion": "0.53.3 (13af8ed4)",
    "openSubsonic": true,
    "searchResult2": {
      "song": [
        {
          "id": "33b918f129ef15277b34db2eec29157e",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Can Dry Leaves Help Us?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 13,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-33b918f129ef15277b34db2eec29157e_66d46a5c",
          "size": 5321905,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 233,
          "bitRate": 181,
          "path": "Gustavo Santaolalla/21 Grams/13 - Can Dry Leaves Help Us?.mp3",
          "created": "2025-02-10T04:25:54.893155512Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 41,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -3.66,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "3c2cd63fd32f03108b786a06a204810b",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Can Dry Leaves Help Us?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 13,
          "year": 2003,
          "coverArt": "mf-3c2cd63fd32f03108b786a06a204810b_6728cedd",
          "size": 5327674,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 233,
          "bitRate": 181,
          "path": "Gustavo Santaolalla/21 Grams/13 - Can Dry Leaves Help Us?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.094030242Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 41,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "ffb272f0-5854-44cc-ada7-49ebe13de320",
          "genres": [],
          "replayGain": {
            "trackGain": -3.66,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "a99c6895f35b23c65cf8e027adca8b07",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Can Emptiness Be Filled?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 6,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-a99c6895f35b23c65cf8e027adca8b07_66d46a5c",
          "size": 1428692,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 65,
          "bitRate": 170,
          "path": "Gustavo Santaolalla/21 Grams/06 - Can Emptiness Be Filled?.mp3",
          "created": "2025-02-10T04:25:54.893083085Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 114,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -3.65,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "565eef209080f463b006811e74a9a9c4",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Can Emptiness Be Filled?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 6,
          "year": 2003,
          "coverArt": "mf-565eef209080f463b006811e74a9a9c4_6728cedd",
          "size": 1428896,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 65,
          "bitRate": 170,
          "path": "Gustavo Santaolalla/21 Grams/06 - Can Emptiness Be Filled?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.094083043Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 114,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "39424e2e-a879-4591-b550-e455d6caa308",
          "genres": [],
          "replayGain": {
            "trackGain": -3.65,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "d54d8185e56ad078b23c230627313c6b",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Can I Be Forgiven?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 8,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-d54d8185e56ad078b23c230627313c6b_66d46a5c",
          "size": 1713248,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 97,
          "bitRate": 138,
          "path": "Gustavo Santaolalla/21 Grams/08 - Can I Be Forgiven?.mp3",
          "created": "2025-02-10T04:25:54.892978252Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 36,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -5.84,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "9488f3bd9c255d60237e623572ccb19d",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Can I Be Forgiven?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 8,
          "year": 2003,
          "coverArt": "mf-9488f3bd9c255d60237e623572ccb19d_6728cedd",
          "size": 1713597,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 97,
          "bitRate": 138,
          "path": "Gustavo Santaolalla/21 Grams/08 - Can I Be Forgiven?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.094056433Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 36,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "3900ad56-1ea2-48ed-88ec-680a8658ea9c",
          "genres": [],
          "replayGain": {
            "trackGain": -5.84,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "a2405e7672216b8b7ef921d4db179fd4",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Can Light Be Found In The Darkness?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 15,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-a2405e7672216b8b7ef921d4db179fd4_66d46a5c",
          "size": 3098055,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 146,
          "bitRate": 167,
          "path": "Gustavo Santaolalla/21 Grams/15 - Can Light Be Found In The Darkness?.mp3",
          "created": "2025-02-10T04:25:54.893324879Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 94,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -5.09,
            "trackPeak": 0.923,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "db721f72116c33be5803c8491ba15774",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Can Light Be Found in the Darkness?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 15,
          "year": 2003,
          "coverArt": "mf-db721f72116c33be5803c8491ba15774_6728cedd",
          "size": 3101295,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 146,
          "bitRate": 167,
          "path": "Gustavo Santaolalla/21 Grams/15 - Can Light Be Found in the Darkness?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.09392038Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 94,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "af221d79-769c-4302-bda2-6ee37f5ea1fd",
          "genres": [],
          "replayGain": {
            "trackGain": -5.09,
            "trackPeak": 0.923,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "8aa9f91f0e4d31862b31c7fa3065ccaa",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Can Things Be Better?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 2,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-8aa9f91f0e4d31862b31c7fa3065ccaa_66d46a5c",
          "size": 1899566,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 79,
          "bitRate": 189,
          "path": "Gustavo Santaolalla/21 Grams/02 - Can Things Be Better?.mp3",
          "created": "2025-02-10T04:25:54.893250427Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 98,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -6.07,
            "trackPeak": 0.891,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "4590b3940c328d1efa14a7f8116929c0",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Can Things Be Better?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 2,
          "year": 2003,
          "coverArt": "mf-4590b3940c328d1efa14a7f8116929c0_6728cedd",
          "size": 1900991,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 79,
          "bitRate": 189,
          "path": "Gustavo Santaolalla/21 Grams/02 - Can Things Be Better?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.094003632Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 98,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "22e3f79e-4a74-4d90-a9da-139f7e61de58",
          "genres": [],
          "replayGain": {
            "trackGain": -6.07,
            "trackPeak": 0.891,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "17d92c0959f7890c814d78e3e8c68d75",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Can We Mix The Unmixable? (Remix)",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 14,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-17d92c0959f7890c814d78e3e8c68d75_66d46a5c",
          "size": 3252655,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 119,
          "bitRate": 216,
          "path": "Gustavo Santaolalla/21 Grams/14 - Can We Mix The Unmixable? (Remix).mp3",
          "created": "2025-02-10T04:25:54.893126946Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 104,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -2.96,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "b766e95015d113e2105be884e602a6ac",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Can We Mix the Unmixable? (remix)",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 14,
          "year": 2003,
          "coverArt": "mf-b766e95015d113e2105be884e602a6ac_6728cedd",
          "size": 3257274,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 119,
          "bitRate": 216,
          "path": "Gustavo Santaolalla/21 Grams/14 - Can We Mix the Unmixable? (remix).mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.093780206Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 104,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "b5acc24e-6509-4a1b-8d94-0104d2c718f0",
          "genres": [],
          "replayGain": {
            "trackGain": -2.96,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "bad327b802a6465b2e6b42a989b7bac4",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Cut Chemist Suite",
          "album": "21 Grams",
          "artist": "Ozomatli",
          "track": 4,
          "year": 2003,
          "coverArt": "mf-bad327b802a6465b2e6b42a989b7bac4_6728cedd",
          "size": 6843774,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 273,
          "bitRate": 199,
          "path": "Gustavo Santaolalla/21 Grams/04 - Cut Chemist Suite.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.093863179Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "type": "music",
          "isVideo": false,
          "bpm": 97,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "31e45c73-f166-459b-97c9-7983cf65313c",
          "genres": [],
          "replayGain": {
            "trackGain": -5.96,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "002724d0ef001280d2ead1c464a7c304",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Cut Chemist Suite (Performed By Ozomatli)",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 4,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-002724d0ef001280d2ead1c464a7c304_66d46a5c",
          "size": 6835637,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 273,
          "bitRate": 199,
          "path": "Gustavo Santaolalla/21 Grams/04 - Cut Chemist Suite (Performed By Ozomatli).mp3",
          "created": "2025-02-10T04:25:54.893223189Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 97,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -5.96,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "1857c79aab318d64797161061c672f2b",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Did This Really Happen?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 3,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-1857c79aab318d64797161061c672f2b_66d46a5c",
          "size": 1322175,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 62,
          "bitRate": 164,
          "path": "Gustavo Santaolalla/21 Grams/03 - Did This Really Happen?.mp3",
          "created": "2025-02-10T04:25:54.893296523Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 111,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -2.73,
            "trackPeak": 0.902,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "c34246e5db6cd0ed6412e4747cd10206",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Did This Really Happen?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 3,
          "year": 2003,
          "coverArt": "mf-c34246e5db6cd0ed6412e4747cd10206_6728cedd",
          "size": 1322256,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 62,
          "bitRate": 164,
          "path": "Gustavo Santaolalla/21 Grams/03 - Did This Really Happen?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.093977022Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 111,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "989deb5d-9183-49e8-82d8-bf836892d795",
          "genres": [],
          "replayGain": {
            "trackGain": -2.73,
            "trackPeak": 0.902,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "65b8a4f9f9f65054e3e914b556fe765d",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Do We Lose 21 Grams?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 1,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-65b8a4f9f9f65054e3e914b556fe765d_66d46a5c",
          "size": 3232942,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "starred": "2025-02-10T04:35:03.601014507Z",
          "duration": 147,
          "bitRate": 173,
          "path": "Gustavo Santaolalla/21 Grams/01 - Do We Lose 21 Grams?.mp3",
          "playCount": 1,
          "created": "2025-02-10T04:25:54.893011148Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "userRating": 5,
          "isVideo": false,
          "played": "2025-02-10T04:27:05.511Z",
          "bpm": 105,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -6.92,
            "trackPeak": 0.881,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "6b525d65ac2f6dc156e01ef87eaf5365",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Do We Lose 21 Grams?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 1,
          "year": 2003,
          "coverArt": "mf-6b525d65ac2f6dc156e01ef87eaf5365_6728cedd",
          "size": 3235391,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 147,
          "bitRate": 173,
          "path": "Gustavo Santaolalla/21 Grams/01 - Do We Lose 21 Grams?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.093947968Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 105,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "afedbb7f-d0f7-484d-9077-772903a46d79",
          "genres": [],
          "replayGain": {
            "trackGain": -6.92,
            "trackPeak": 0.881,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "f9bdfdd74e4e1dec566c83ea1f28a110",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Does He Who Looks For The Truth, Deserve The Punishment For Finding It?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 11,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-f9bdfdd74e4e1dec566c83ea1f28a110_66d46a5c",
          "size": 1678635,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 101,
          "bitRate": 130,
          "path": "Gustavo Santaolalla/21 Grams/11 - Does He Who Looks For The Truth, Deserve The Punishment For Finding It?.mp3",
          "created": "2025-02-10T04:25:54.892907153Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 93,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -6.27,
            "trackPeak": 0.933,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "5649cf7f00dd4c6fd748f848c18aa066",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Does He Who Looks for the Truth, Deserve the Punishment for Finding It?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 11,
          "year": 2003,
          "coverArt": "mf-5649cf7f00dd4c6fd748f848c18aa066_6728cedd",
          "size": 1679228,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 101,
          "bitRate": 130,
          "path": "Gustavo Santaolalla/21 Grams/11 - Does He Who Looks for the Truth, Deserve the Punishment for Finding It?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.093891745Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 93,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "638e52a0-4d41-4cb1-a453-56aae9cd37aa",
          "genres": [],
          "replayGain": {
            "trackGain": -6.27,
            "trackPeak": 0.933,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "dc22f36eafcaa5acec9f8230b4c49513",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Is There A Way To Help Her?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 10,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-dc22f36eafcaa5acec9f8230b4c49513_66d46a5c",
          "size": 1004612,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 45,
          "bitRate": 171,
          "path": "Gustavo Santaolalla/21 Grams/10 - Is There A Way To Help Her?.mp3",
          "created": "2025-02-10T04:25:54.893046767Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 110,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -5.18,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "1a72fdb9d073bbd593fa97f0a4d96325",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Is There a Way to Help Her?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 10,
          "year": 2003,
          "coverArt": "mf-1a72fdb9d073bbd593fa97f0a4d96325_6728cedd",
          "size": 1004118,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 45,
          "bitRate": 171,
          "path": "Gustavo Santaolalla/21 Grams/10 - Is There a Way to Help Her?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.09371644Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 110,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "458d1608-25a2-4e3d-84b9-ca7cb619c4a4",
          "genres": [],
          "replayGain": {
            "trackGain": -5.18,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "4e88252a5015a0f23665b1bf5d9ae0e6",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Low Rider",
          "album": "21 Grams",
          "artist": "War",
          "track": 9,
          "year": 2003,
          "coverArt": "mf-4e88252a5015a0f23665b1bf5d9ae0e6_6728cedd",
          "size": 5353148,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 188,
          "bitRate": 225,
          "path": "Gustavo Santaolalla/21 Grams/09 - Low Rider.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.094109792Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "type": "music",
          "isVideo": false,
          "bpm": 139,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "917b535e-01eb-45b2-ace0-b1bada913833",
          "genres": [],
          "replayGain": {
            "trackGain": -6.3,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "250ea31df254d98d38287acae24dd461",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Low Rider (Performed by WAR)",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 9,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-250ea31df254d98d38287acae24dd461_66d46a5c",
          "size": 5346439,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 188,
          "bitRate": 225,
          "path": "Gustavo Santaolalla/21 Grams/09 - Low Rider (Performed by WAR).mp3",
          "created": "2025-02-10T04:25:54.893389274Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 139,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -6.3,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "7c7e12de405763b01074dcec4c26debb",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Shake Rattle And Roll",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 7,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-7c7e12de405763b01074dcec4c26debb_66d46a5c",
          "size": 8127652,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 372,
          "bitRate": 174,
          "path": "Gustavo Santaolalla/21 Grams/07 - Shake Rattle And Roll.mp3",
          "created": "2025-02-10T04:25:54.893183728Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 111,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -6.97,
            "trackPeak": 0.923,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "6f3c8efc5d5b64dff4c6e1062b28366b",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Shake Rattle and Roll",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 7,
          "year": 2003,
          "coverArt": "mf-6f3c8efc5d5b64dff4c6e1062b28366b_6728cedd",
          "size": 8136677,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 372,
          "bitRate": 174,
          "path": "Gustavo Santaolalla/21 Grams/07 - Shake Rattle and Roll.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.093807864Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 111,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "40bf7935-faf6-4d6b-9277-404cf3a28b1d",
          "genres": [],
          "replayGain": {
            "trackGain": -6.97,
            "trackPeak": 0.923,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "a8171bd6ff477e9fb25febd428872b47",
          "parent": "c2696ddbcd8fc89c861547c307e0a076",
          "isDir": false,
          "title": "Should I Let Her Know?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 5,
          "year": 2002,
          "genre": "Soundtrack",
          "coverArt": "mf-a8171bd6ff477e9fb25febd428872b47_66d46a5c",
          "size": 1889494,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 88,
          "bitRate": 168,
          "path": "Gustavo Santaolalla/21 Grams/05 - Should I Let Her Know?.mp3",
          "created": "2025-02-10T04:25:54.893356378Z",
          "albumId": "c2696ddbcd8fc89c861547c307e0a076",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 65,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "",
          "genres": [
            {
              "name": "Soundtrack"
            }
          ],
          "replayGain": {
            "trackGain": -3.43,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "4786d647d954b058047e9a8a5b26817a",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "Should I Let Her Know?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla",
          "track": 5,
          "year": 2003,
          "coverArt": "mf-4786d647d954b058047e9a8a5b26817a_6728cedd",
          "size": 1891170,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 88,
          "bitRate": 168,
          "path": "Gustavo Santaolalla/21 Grams/05 - Should I Let Her Know?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.09383601Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "artistId": "38ec9eabef4778ac77923ad3a59a23f9",
          "type": "music",
          "isVideo": false,
          "bpm": 65,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "6939608c-ec83-487a-af02-75b9df565d67",
          "genres": [],
          "replayGain": {
            "trackGain": -3.43,
            "trackPeak": 1,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        },
        {
          "id": "59201fa8928057a7317bf75ba34a2b39",
          "parent": "8c5699d04a17d32e7bdb438c963f436f",
          "isDir": false,
          "title": "When Our Wings Are Cut, Can We Still Fly?",
          "album": "21 Grams",
          "artist": "Gustavo Santaolalla feat. Kronos Quartet",
          "track": 16,
          "year": 2003,
          "coverArt": "mf-59201fa8928057a7317bf75ba34a2b39_6728cedd",
          "size": 3051900,
          "contentType": "audio/mpeg",
          "suffix": "mp3",
          "duration": 142,
          "bitRate": 168,
          "path": "Gustavo Santaolalla/21 Grams/16 - When Our Wings Are Cut, Can We Still Fly?.mp3",
          "discNumber": 1,
          "created": "2025-02-10T04:25:56.093750244Z",
          "albumId": "8c5699d04a17d32e7bdb438c963f436f",
          "type": "music",
          "isVideo": false,
          "bpm": 154,
          "comment": "",
          "sortName": "",
          "mediaType": "song",
          "musicBrainzId": "04553da0-fe93-43c8-9671-fdeb8adf0484",
          "genres": [],
          "replayGain": {
            "trackGain": -1.3,
            "trackPeak": 0.841,
            "albumPeak": 1
          },
          "channelCount": 2,
          "samplingRate": 44100
        }
      ]
    }
  }
}
					""".encodeToByteArray().inputStream()
				)
			}
		}

		LiveSubsonicConnection(
			SubsonicConnectionDetails(TestUrl, "Xtbyp9lhSJY", "WVe5KSj"),
			FakeHttpConnectionProvider(httpConnection),
			mockk(),
			JsonEncoderDecoder,
			mockk(),
		)
	}

	private var items = emptyList<ServiceFile>()

	@BeforeAll
	fun act() {
		items = mut.promiseFiles(query).toExpiringFuture().get()!!
	}

	@Test
	fun `then the items are correct`() {
		assertThat(items).containsExactly(
			ServiceFile(key="33b918f129ef15277b34db2eec29157e"),
			ServiceFile(key="3c2cd63fd32f03108b786a06a204810b"),
			ServiceFile(key="a99c6895f35b23c65cf8e027adca8b07"),
			ServiceFile(key="565eef209080f463b006811e74a9a9c4"),
			ServiceFile(key="d54d8185e56ad078b23c230627313c6b"),
			ServiceFile(key="9488f3bd9c255d60237e623572ccb19d"),
			ServiceFile(key="a2405e7672216b8b7ef921d4db179fd4"),
			ServiceFile(key="db721f72116c33be5803c8491ba15774"),
			ServiceFile(key="8aa9f91f0e4d31862b31c7fa3065ccaa"),
			ServiceFile(key="4590b3940c328d1efa14a7f8116929c0"),
			ServiceFile(key="17d92c0959f7890c814d78e3e8c68d75"),
			ServiceFile(key="b766e95015d113e2105be884e602a6ac"),
			ServiceFile(key="bad327b802a6465b2e6b42a989b7bac4"),
			ServiceFile(key="002724d0ef001280d2ead1c464a7c304"),
			ServiceFile(key="1857c79aab318d64797161061c672f2b"),
			ServiceFile(key="c34246e5db6cd0ed6412e4747cd10206"),
			ServiceFile(key="65b8a4f9f9f65054e3e914b556fe765d"),
			ServiceFile(key="6b525d65ac2f6dc156e01ef87eaf5365"),
			ServiceFile(key="f9bdfdd74e4e1dec566c83ea1f28a110"),
			ServiceFile(key="5649cf7f00dd4c6fd748f848c18aa066"),
			ServiceFile(key="dc22f36eafcaa5acec9f8230b4c49513"),
			ServiceFile(key="1a72fdb9d073bbd593fa97f0a4d96325"),
			ServiceFile(key="4e88252a5015a0f23665b1bf5d9ae0e6"),
			ServiceFile(key="250ea31df254d98d38287acae24dd461"),
			ServiceFile(key="7c7e12de405763b01074dcec4c26debb"),
			ServiceFile(key="6f3c8efc5d5b64dff4c6e1062b28366b"),
			ServiceFile(key="a8171bd6ff477e9fb25febd428872b47"),
			ServiceFile(key="4786d647d954b058047e9a8a5b26817a"),
			ServiceFile(key="59201fa8928057a7317bf75ba34a2b39")
		)
	}
}
